name: Build LLGL

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/build-llgl.yml'

jobs:
  linux-x64:
    name: Linux x64
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 3 }

      - name: Install build deps (X11/Xrandr + Vulkan)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git \
              libx11-dev libxrandr-dev libxext-dev libxi-dev \
              libvulkan-dev

      - name: Clone and build LLGL (shared + C99 + Vulkan only)
        run: |
          git clone --depth 1 https://github.com/LukasBanana/LLGL.git llgl
          cd llgl
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DLLGL_BUILD_EXAMPLES=OFF \
            -DLLGL_BUILD_WRAPPER_C99=ON \
            -DLLGL_BUILD_RENDERER_VULKAN=ON \
            -DLLGL_BUILD_RENDERER_OPENGL=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D11=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D12=OFF \
            -DLLGL_BUILD_RENDERER_METAL=OFF
          cmake --build build --config Release
          find build -type f -name "libLLGL*.so*" -exec strip -S {} + || true

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/x64/linux
          find llgl/build -type f -name "libLLGL*.so*" -exec cp {} artifacts/x64/linux/ \; || true

      - uses: actions/upload-artifact@v4
        with: { name: linux-x64, path: artifacts/, retention-days: 7 }

  macos:
    name: macOS
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        ARCH: [x64, arm64]
        include:
          - ARCH: x64
            CMAKE_ARCH: x86_64
            OSX_MIN: '10.15.4'
          - ARCH: arm64
            CMAKE_ARCH: arm64
            OSX_MIN: '11.0'
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 3 }

      # Em vez de baixar o SDK completo, constrÃ³i Headers+Loader e seta VULKAN_SDK
      - name: Setup Vulkan SDK (headers+loader)
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-query-version: 1.4.304.1
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true

      - name: Clone and build LLGL (shared + C99 + Vulkan only)
        run: |
          git clone --depth 1 https://github.com/LukasBanana/LLGL.git llgl
          cd llgl
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{matrix.CMAKE_ARCH}} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=${{matrix.OSX_MIN}} \
            -DBUILD_SHARED_LIBS=ON \
            -DLLGL_BUILD_EXAMPLES=OFF \
            -DLLGL_BUILD_WRAPPER_C99=ON \
            -DLLGL_BUILD_RENDERER_VULKAN=ON \
            -DLLGL_BUILD_RENDERER_OPENGL=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D11=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D12=OFF \
            -DLLGL_BUILD_RENDERER_METAL=OFF
          cmake --build build --config Release
          find build -type f -name "libLLGL*.dylib" -exec strip -u -r {} + || true

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/${{matrix.ARCH}}/darwin
          find llgl/build -type f -name "libLLGL*.dylib" -exec cp {} artifacts/${{matrix.ARCH}}/darwin/ \; || true

      - uses: actions/upload-artifact@v4
        with: { name: macos-${{matrix.ARCH}}, path: artifacts/, retention-days: 7 }

  windows-x64:
    name: Windows x64
    runs-on: windows-2022
    defaults: { run: { shell: cmd } }
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 3 }

      - uses: ilammy/msvc-dev-cmd@v1
        with: { arch: amd64 }

      # Prepara Headers+Loader e exporta VULKAN_SDK para o job
      - name: Setup Vulkan SDK (headers+loader)
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-query-version: 1.4.304.1
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true

      - name: Clone and build LLGL (shared + C99 + Vulkan only)
        run: |
          git clone --depth 1 https://github.com/LukasBanana/LLGL.git llgl
          cd llgl
          cmake -S . -B build ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DBUILD_SHARED_LIBS=ON ^
            -DLLGL_BUILD_EXAMPLES=OFF ^
            -DLLGL_BUILD_WRAPPER_C99=ON ^
            -DLLGL_BUILD_RENDERER_VULKAN=ON ^
            -DLLGL_BUILD_RENDERER_OPENGL=OFF ^
            -DLLGL_BUILD_RENDERER_DIRECT3D11=OFF ^
            -DLLGL_BUILD_RENDERER_DIRECT3D12=OFF ^
            -DLLGL_BUILD_RENDERER_METAL=OFF
          cmake --build build --config Release

      - name: Prepare artifacts
        run: |
          mkdir artifacts\x64\win32\
          for /r llgl\build %%F in (*.dll) do copy "%%F" artifacts\x64\win32\ >NUL

      - uses: actions/upload-artifact@v4
        with: { name: windows-x64, path: artifacts/, retention-days: 7 }
