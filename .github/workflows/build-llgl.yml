name: Build LLGL

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - '.github/workflows/build-llgl.yml'

jobs:
  linux-x64:
    name: Linux x64
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 3

      - name: Install build deps (X11/Xrandr + Vulkan)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git \
              libx11-dev libxrandr-dev libxext-dev libxi-dev \
              libvulkan-dev

      - name: Clone and build LLGL (shared + C99 + Vulkan only)
        run: |
          git clone --depth 1 --branch release-0.04b https://github.com/LukasBanana/LLGL.git llgl
          cd llgl
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DLLGL_BUILD_EXAMPLES=OFF \
            -DLLGL_BUILD_WRAPPER_C99=ON \
            -DLLGL_BUILD_RENDERER_VULKAN=ON \
            -DLLGL_BUILD_RENDERER_OPENGL=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D11=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D12=OFF \
            -DLLGL_BUILD_RENDERER_METAL=OFF
          cmake --build build --config Release
          # strip libs (se existirem)
          find build -type f -name "libLLGL*.so*" -exec strip -S {} + || true

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/x64/linux
          # Copia todas as .so relevantes
          find llgl/build -type f \( -name "libLLGL*.so*" -o -name "*Vulkan*.so*" -o -name "*C99*.so*" \) -exec cp {} artifacts/x64/linux/ \; || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: artifacts/
          retention-days: 7

  linux-arm64:
    name: Linux ARM64 (cross)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 3

      - name: Install cross toolchain
        run: |
          sudo apt-get -y update
          sudo apt-get -y install cmake gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libc6-dev-arm64-cross

      - name: Enable arm64 apt sources
        run: |
          sudo dpkg --add-architecture arm64
          sudo sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $(lsb_release -sc) main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm64.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $(lsb_release -sc)-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/arm64.list
          sudo apt-get update || true

      - name: Install arm64 deps (X11/Xrandr + Vulkan)
        run: |
          sudo apt-get -y install --allow-unauthenticated \
            libx11-dev:arm64 \
            libxrandr-dev:arm64 \
            libxext-dev:arm64 \
            libxi-dev:arm64 \
            libvulkan-dev:arm64 \
            libxinerama-dev:arm64 \
            libxcursor-dev:arm64 || echo "Some packages may have failed"

      - name: Clone and try to build LLGL for arm64
        run: |
          git clone --depth 1 --branch release-0.04b https://github.com/LukasBanana/LLGL.git llgl
          cd llgl
          cat > toolchain-aarch64.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
          set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu /usr)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_LIBRARY_ARCHITECTURE aarch64-linux-gnu)
          # Set Vulkan paths for cross-compilation
          set(Vulkan_INCLUDE_DIR /usr/include CACHE PATH "Vulkan include directory")
          set(Vulkan_LIBRARY /usr/lib/aarch64-linux-gnu/libvulkan.so CACHE FILEPATH "Vulkan library")
          EOF
          cmake -S . -B build \
            -DCMAKE_TOOLCHAIN_FILE=toolchain-aarch64.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DLLGL_BUILD_EXAMPLES=OFF \
            -DLLGL_BUILD_WRAPPER_C99=ON \
            -DLLGL_BUILD_RENDERER_VULKAN=ON \
            -DLLGL_BUILD_RENDERER_OPENGL=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D11=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D12=OFF \
            -DLLGL_BUILD_RENDERER_METAL=OFF
          cmake --build build --config Release
          # Strip libs if built
          find build -type f -name "*.so*" -exec aarch64-linux-gnu-strip -S {} + || true

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/arm64/linux
          # Copy all .so files found
          if find llgl/build -type f -name "*.so*" -print -quit | grep -q .; then
            find llgl/build -type f -name "*.so*" -exec cp -v {} artifacts/arm64/linux/ \;
            echo "ARM64 build completed successfully:"
            ls -lh artifacts/arm64/linux/
          else
            echo "ERROR: No .so files found - build failed"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: artifacts/
          retention-days: 7

  macos:
    name: macOS
    strategy:
      fail-fast: false
      matrix:
        include:
          - ARCH: x64
            PLATFORM: osx-x64
            CMAKE_ARCH: x86_64
            OSX_MIN: '10.15.4'
            RUNNER: macos-13
          - ARCH: arm64
            PLATFORM: osx-arm64
            CMAKE_ARCH: arm64
            OSX_MIN: '11.0'
            RUNNER: macos-14
    runs-on: ${{matrix.RUNNER}}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 3

      - name: Install Vulkan SDK
        run: |
          brew install vulkan-headers vulkan-loader molten-vk
          VULKAN_SDK_PATH=$(brew --prefix molten-vk)
          echo "VULKAN_SDK=$VULKAN_SDK_PATH" >> $GITHUB_ENV
          echo "Vulkan SDK installed at: $VULKAN_SDK_PATH"
          ls -la "$VULKAN_SDK_PATH/lib/" || true

      - name: Clone and build LLGL (shared + C99 + Vulkan only)
        run: |
          git clone --depth 1 --branch release-0.04b https://github.com/LukasBanana/LLGL.git llgl
          cd llgl
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{matrix.CMAKE_ARCH}} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=${{matrix.OSX_MIN}} \
            -DBUILD_SHARED_LIBS=ON \
            -DLLGL_BUILD_EXAMPLES=OFF \
            -DLLGL_BUILD_WRAPPER_C99=ON \
            -DLLGL_BUILD_RENDERER_VULKAN=ON \
            -DLLGL_BUILD_RENDERER_OPENGL=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D11=OFF \
            -DLLGL_BUILD_RENDERER_DIRECT3D12=OFF \
            -DLLGL_BUILD_RENDERER_METAL=OFF
          cmake --build build --config Release
          strip -u -r build/src/*.dylib || true
          strip -u -r build/wrapper/C99/*.dylib || true

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/${{matrix.ARCH}}/darwin
          find llgl/build -type f -name "*.dylib" -exec cp {} artifacts/${{matrix.ARCH}}/darwin/ \;

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{matrix.ARCH}}
          path: artifacts/
          retention-days: 7

  windows-x64:
    name: Windows x64
    runs-on: windows-2022
    defaults:
      run:
        shell: cmd
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 3

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64

      - name: Cache Vulkan SDK
        id: cache-vulkan
        uses: actions/cache@v4
        with:
          path: C:\VulkanSDK\1.3.290.0
          key: vulkan-sdk-1.3.290.0-windows-minimal

      - name: Setup Vulkan SDK
        if: steps.cache-vulkan.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "Downloading Vulkan SDK runtime files..."
          $ProgressPreference = 'SilentlyContinue'
          
          # Download runtime-only zip (much faster than full installer)
          $runtimeUrl = "https://sdk.lunarg.com/sdk/download/1.3.290.0/windows/vulkan-runtime-components.zip"
          $zipPath = "$env:TEMP\vulkan-runtime.zip"
          
          try {
            Invoke-WebRequest -Uri $runtimeUrl -OutFile $zipPath -TimeoutSec 300
            
            # Extract to VulkanSDK directory
            $targetPath = "C:\VulkanSDK\1.3.290.0"
            New-Item -ItemType Directory -Force -Path $targetPath | Out-Null
            Expand-Archive -Path $zipPath -DestinationPath $targetPath -Force
            
            Write-Host "Vulkan SDK runtime extracted successfully"
          } catch {
            Write-Host "Runtime download failed, trying minimal manual setup..."
            
            # Fallback: Create minimal structure with headers only
            $targetPath = "C:\VulkanSDK\1.3.290.0"
            New-Item -ItemType Directory -Force -Path "$targetPath\Include\vulkan" | Out-Null
            New-Item -ItemType Directory -Force -Path "$targetPath\Lib" | Out-Null
            New-Item -ItemType Directory -Force -Path "$targetPath\Bin" | Out-Null
            
            # Download just the Vulkan headers
            $headerUrl = "https://raw.githubusercontent.com/KhronosGroup/Vulkan-Headers/v1.3.290/include/vulkan/vulkan.h"
            Invoke-WebRequest -Uri $headerUrl -OutFile "$targetPath\Include\vulkan\vulkan.h"
            
            Write-Host "Minimal Vulkan SDK setup completed"
          }

      - name: Configure Vulkan SDK Environment
        shell: pwsh
        run: |
          $vulkanPath = "C:\VulkanSDK\1.3.290.0"
          if (Test-Path $vulkanPath) {
            echo "VULKAN_SDK=$vulkanPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            echo "$vulkanPath\Bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Vulkan SDK configured: $vulkanPath"
          } else {
            Write-Error "Vulkan SDK not found at $vulkanPath"
            exit 1
          }      - name: Clone and build LLGL (shared + C99 + Vulkan only)
        run: |
          git clone --depth 1 --branch release-0.04b https://github.com/LukasBanana/LLGL.git llgl
          cd llgl
          cmake -S . -B build ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DBUILD_SHARED_LIBS=ON ^
            -DLLGL_BUILD_EXAMPLES=OFF ^
            -DLLGL_BUILD_WRAPPER_C99=ON ^
            -DLLGL_BUILD_RENDERER_VULKAN=ON ^
            -DLLGL_BUILD_RENDERER_OPENGL=OFF ^
            -DLLGL_BUILD_RENDERER_DIRECT3D11=OFF ^
            -DLLGL_BUILD_RENDERER_DIRECT3D12=OFF ^
            -DLLGL_BUILD_RENDERER_METAL=OFF
          cmake --build build --config Release

      - name: Prepare artifacts
        run: |
          mkdir artifacts\x64\win32
          xcopy /Y llgl\build\src\Release\*.dll artifacts\x64\win32\ 2>nul || echo No src DLLs
          xcopy /Y llgl\build\wrapper\C99\Release\*.dll artifacts\x64\win32\ 2>nul || echo No C99 DLLs
          for /r llgl\build %%F in (*.dll) do copy "%%F" artifacts\x64\win32\ >nul 2>&1
        shell: cmd

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: artifacts/
          retention-days: 7
